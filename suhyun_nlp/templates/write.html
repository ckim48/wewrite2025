{% extends 'header.html' %}
{% block write %}
  <style>
    /* Page shell */
    body{
      background:#f7f8fb;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;color:#222;
      min-height:100vh;display:flex;justify-content:center;align-items:flex-start;
    }
    .write-wrapper{width:100%;max-width:880px;padding:20px;margin-top:96px;}
    .write-container{
      background:#fff;border:1px solid #eef0f4;border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);padding:28px 28px 32px;
    }

    /* Headings */
    h1{font-size:28px;line-height:1.2;margin:0;color:#111;font-weight:700;}
    .sub{margin:.4rem 0 20px;color:#6b7280;font-size:14px;}

    /* Form controls */
    .form-group{margin:18px 0 20px;}
    .form-label{display:block;font-weight:600;margin-bottom:8px;color:#111;}
    .hint{color:#6b7280;font-size:12px;margin-top:6px;}

    .field{
      width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;
      background:#fff;font-size:14px;transition:border-color .15s ease, box-shadow .15s ease;
    }
    .field:focus{outline:none;border-color:#3c3f58;box-shadow:0 0 0 3px rgba(60,63,88,.15);}
    textarea.field{resize:vertical;min-height:110px;}

    /* --- Genre: simple, clean, single-select --- */
    .genre-grid{
      display:grid;gap:10px;
      grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    }
    .genre-radio{display:none;}
    .genre-pill{
      display:flex;align-items:center;justify-content:center;
      height:40px;border-radius:999px;border:1px solid #e5e7eb;background:#fafbfc;
      font-size:13px;font-weight:600;color:#374151;cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      user-select:none; outline: none;
    }
    .genre-pill:hover{background:#f2f4f7;}
    .genre-pill:focus-visible{box-shadow:0 0 0 3px rgba(60,63,88,.18);}

    /* selected */
    .genre-radio:checked + .genre-pill{
      background:#3c3f58;color:#fff;border-color:#3c3f58;
      box-shadow:0 6px 16px rgba(60,63,88,.25);
    }

    /* Submit */
    .btn-primary{
      appearance:none;border:0;border-radius:12px;background:#3c3f58;color:#fff;
      padding:12px 16px;font-weight:700;font-size:15px;width:100%;
      transition:filter .15s ease, transform .02s ease; cursor:pointer;
    }
    .btn-primary:hover{filter:brightness(1.02);}
    .btn-primary:active{transform:translateY(1px);}

    /* Loading overlay */
    #loading-screen{
      position:fixed;inset:0;display:none;background:rgba(255,255,255,.55);
      z-index:9999;display:flex;align-items:center;justify-content:center;
    }
  </style>

  <div class="write-wrapper">
    <div class="write-container">
      <form action="{% url 'to-write' %}" method="POST">
        {% csrf_token %}
        <h1>Start a new story</h1>
        <p class="sub">Pick a genre, add your basics, and write your opening.</p>

        <!-- Genre -->
        <div class="form-group">
          <label class="form-label">Genre</label>
          <div class="genre-grid">
            {% for g in genres %}
              <input class="genre-radio" type="radio" name="selected_genre" value="{{ g.name }}" id="genre_{{ g.id }}">
              <label class="genre-pill" for="genre_{{ g.id }}">{{ g.name }}</label>
            {% empty %}
              <span class="hint">No active genres available.</span>
            {% endfor %}
          </div>
          <div class="hint">Choose one.</div>
        </div>

        <!-- Title -->
        <div class="form-group">
          <label for="title" class="form-label">Title</label>
          <input id="title" name="title" type="text" class="field" placeholder="Enter a captivating title" required>
        </div>

        <!-- Main character -->
        <div class="form-group">
          <label for="main-character" class="form-label">Main character</label>
          <input id="main-character" name="maincharacter" type="text" class="field" placeholder="e.g., Luna, the curious explorer">
        </div>

        <!-- Time setting -->
        <div class="form-group">
          <label for="time-setting" class="form-label">Time setting</label>
          <input id="time-setting" name="timesetting" type="text" class="field" placeholder="e.g., Year 3024, Ancient Korea">
        </div>

        <!-- Exposition -->
        <div class="form-group">
          <label for="exposition" class="form-label">Exposition</label>
          <textarea id="exposition" name="exposition" class="field" placeholder="Write the opening of your story here..."></textarea>
        </div>

        <button type="submit" class="btn-primary">Submit your story</button>
      </form>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading-screen">
    <div style="text-align:center">
      <div style="font-size:16px;color:#3c3f58;margin-bottom:10px;">Generating keywords and summary…</div>
      <div class="spinner-border text-secondary" role="status" style="width:2.4rem;height:2.4rem">
        <span class="visually-hidden">Loading…</span>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('.write-container form');
  const overlay = document.getElementById('loading-screen');
  const submitBtn = form?.querySelector('button[type="submit"]');

  if (!form || !overlay) return;

  // Always start hidden (in case of bfcache restore)
  overlay.style.display = 'none';

  form.addEventListener('submit', (e) => {
    // If invalid, STOP and show native validation UI
    if (!form.checkValidity()) {
      e.preventDefault();
      form.reportValidity();
      return;
    }
    // Valid -> show overlay and prevent double submit
    overlay.style.display = 'flex';
    if (submitBtn) submitBtn.disabled = true;
  });

  // If the page is restored from bfcache (e.g., back button), hide overlay
  window.addEventListener('pageshow', () => {
    overlay.style.display = 'none';
    if (submitBtn) submitBtn.disabled = false;
  });

  // Safety net: when tab becomes visible again, ensure overlay is hidden
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      overlay.style.display = 'none';
      if (submitBtn) submitBtn.disabled = false;
    }
  });
});
</script>

{% endblock %}
